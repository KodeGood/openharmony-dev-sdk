#!/usr/bin/env bash
set -euo pipefail

script_relpath="${BASH_SOURCE[0]:-"$0"}"
openharmony_dev_sdk_directory="$(readlink -f "$(dirname "$script_relpath")")"

OPENHARMONY_DEV_SDK="$openharmony_dev_sdk_directory"
IMAGE="${OPENHARMONY_DOCKER_IMAGE:-openharmony-dev-sdk:latest}"

WORKDIR="$(pwd -P)"

CONTAINER_HOME="/home/openharmony"
CONTAINER_WORKSPACE="/home/openharmony/workspace"
NAME="${NAME:-ohosdev}"

USER_NAME="$(id -un)"
GROUP_NAME="$(id -gn)"
USER_ID="$(id -u)"
GROUP_ID="$(id -g)"

HOSTNAME_FQDN="$(hostname -f 2>/dev/null || hostname)"
CONTAINER_HOSTNAME="${NAME}.${HOSTNAME_FQDN}"

source "${OPENHARMONY_DEV_SDK}/third-party/bash-argsparse/argsparse.sh"

argsparse_use_option with-prebuilts "Enable mapping of the openharmony tools prebuilts folder (used when building full OpenHarmony system images)"

process_command_line_arguments() {
    argsparse_allow_no_argument "true"
    argsparse_parse_options "${@}"
}

propagate_environment_variables_from_host() {
    local -n out_args=$1
    local -r passthrough_variables=(
        TERM
        WAYLAND_DISPLAY
        DISPLAY
        XDG_SESSION_TYPE
        XDG_RUNTIME_DIR
        SSH_AUTH_SOCK
        USER
    )
    for env in "${passthrough_variables[@]}"; do
        if [[ -n "${!env-}" ]]; then
            out_args+=(-e "${env}=${!env}")
        fi
    done
}

propagate_mounts() {
    local -n out_args=$1

    out_args+=(-v "${WORKDIR}:${CONTAINER_WORKSPACE}")

    if [[ -f "${HOME}/.gitconfig" ]]; then
        out_args+=(-v "${HOME}/.gitconfig:${CONTAINER_HOME}/.gitconfig:ro")
    fi

    out_args+=(-v ${OPENHARMONY_DEV_SDK}/.bashrc:${CONTAINER_HOME}/.bashrc)
    out_args+=(-v ${OPENHARMONY_DEV_SDK}/.bash_logout:${CONTAINER_HOME}/.bash_logout)
    out_args+=(-v ${OPENHARMONY_DEV_SDK}/.profile:${CONTAINER_HOME}/.profile)

    if [[ -n "${XDG_RUNTIME_DIR-}" && -d "${XDG_RUNTIME_DIR}" ]]; then
        out_args+=(-v "${XDG_RUNTIME_DIR}:${XDG_RUNTIME_DIR}")
    fi
}

prepare_prebuilts_mounts() {
    local -n out_mounts=$1

    local mappings=(
        ".npm"
        ".ohpm"
        ".hvigor"
        "openharmony_prebuilts"
    )

    for dir in "${mappings[@]}"; do
        local host_path="${WORKDIR}/${dir}"
        local container_path="${CONTAINER_HOME}/${dir}"
        if [[ ! -d "${host_path}" ]]; then
            echo "[INFO] Creating host directory ${host_path}"
            mkdir -p "${host_path}"
        fi
        if [[ "$(stat -c '%u' "${host_path}")" -ne "${USER_ID}" ]]; then
            echo "[INFO] Fixing ownership for ${host_path}"
            chown -R "${USER_ID}:${GROUP_ID}" "${host_path}"
        fi
        out_mounts+=(-v "${host_path}:${container_path}")
    done

    local npmrc_host="${WORKDIR}/.npmrc"
    local npmrc_container="${CONTAINER_HOME}/.npmrc"
    if [[ ! -f "${npmrc_host}" ]]; then
        echo "[INFO] Creating empty ${npmrc_host}"
        touch "${npmrc_host}"
    fi

    if [[ "$(stat -c '%u' "${npmrc_host}")" -ne "${USER_ID}" ]]; then
        echo "[INFO] Fixing ownership for ${npmrc_host}"
        chown "${USER_ID}:${GROUP_ID}" "${npmrc_host}"
    fi
    out_mounts+=(-v "${npmrc_host}:${npmrc_container}")
}

run() {
    process_command_line_arguments "${@}"

    # Run as root first, then drop privileges inside container
    local -a docker_opts=(
        --rm
        --tty
        --interactive
        --network host
        --name "${NAME}"
        --hostname "${CONTAINER_HOSTNAME}"
        --user root
        -e "HOME=${CONTAINER_HOME}"
        -w "${CONTAINER_WORKSPACE}"
    )

    propagate_environment_variables_from_host docker_opts

    local -a docker_mounts=()
    propagate_mounts docker_mounts

    # Script to fix ownership and drop privileges to host user
    local set_home_ownership_and_switch="
        if [ -d '${CONTAINER_HOME}' ]; then
            OWNER_ID=\$(stat -c '%u' '${CONTAINER_HOME}' 2>/dev/null || echo 0)
            if [ \"\$OWNER_ID\" -ne ${USER_ID} ]; then
                echo '[INFO] Setting ownership of ${CONTAINER_HOME} for UID ${USER_ID}...';
                chown ${USER_ID}:${GROUP_ID} '${CONTAINER_HOME}' || echo '[WARN] Failed to chown ${CONTAINER_HOME}';
            fi
        fi

        if ! grep -q '^${GROUP_NAME}:' /etc/group; then
            echo '[INFO] Adding group ${GROUP_NAME} (GID=${GROUP_ID}) to /etc/group...'
            echo '${GROUP_NAME}:x:${GROUP_ID}:' >> /etc/group
        fi

        if ! grep -q '^${USER_NAME}:' /etc/passwd; then
          echo '[INFO] Adding ${USER_NAME} to /etc/passwd...';
          echo '${USER_NAME}:x:${USER_ID}:${GROUP_ID}:${USER_NAME}:/home/openharmony:/bin/bash' >> /etc/passwd
        fi

        echo '[INFO] Switching to UID ${USER_ID}:${GROUP_ID}...';
        export HOME=${CONTAINER_HOME}
        exec setpriv --reuid=${USER_ID} --regid=${GROUP_ID} --init-groups env HOME=${CONTAINER_HOME} USER=${USER_NAME} bash --login
    "

    if argsparse_is_option_set "with-prebuilts"; then
        prepare_prebuilts_mounts docker_mounts
    fi
    local -a docker_cmd=(bash -lc "${set_home_ownership_and_switch}")

    docker run "${docker_opts[@]}" "${docker_mounts[@]}" "${IMAGE}" "${docker_cmd[@]}"
}

run "$@"

