#!/usr/bin/env bash
set -euo pipefail

script_relpath="${BASH_SOURCE[0]}"
test -z "${script_relpath}" && script_relpath="${0}"
openharmony_dev_sdk_directory="$(readlink -f $(dirname ${script_relpath}))"

OPENHARMONY_DEV_SDK=${openharmony_dev_sdk_directory}
IMAGE="${OPENHARMONY_DOCKER_IMAGE:-openharmony-dev-sdk:latest}"

run() {
    # Ensure docker is available
    if ! command -v docker >/dev/null 2>&1; then
      echo "Error: 'docker' not found in PATH." >&2
      exit 1
    fi

    # Ensure Dockerfile exists where expected
    if [[ ! -f "${OPENHARMONY_DEV_SDK}/Dockerfile" ]]; then
      echo "Error: Dockerfile not found at ${OPENHARMONY_DEV_SDK}/Dockerfile" >&2
      exit 1
    fi

    # Check whether the image already exists
    if docker image inspect "${IMAGE}" >/dev/null 2>&1; then
      echo "Docker image '${IMAGE}' already exists."
    else
      echo "Docker image '${IMAGE}' not found. Building..."
      docker build \
        -t "${IMAGE}" \
        -f "${OPENHARMONY_DEV_SDK}/Dockerfile" \
        "${OPENHARMONY_DEV_SDK}"
      echo "Built image '${IMAGE}'."
    fi
}

run "$@"
